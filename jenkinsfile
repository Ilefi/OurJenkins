pipeline {
    agent any

    tools {
        maven 'M2_HOME'
    }

    environment {
        // Configuration SonarQube - √Ä PERSONNALISER
        SONAR_PROJECT_KEY = 'jenkins-ilef'  // CHANGE ICI : Ton projet key
        SONAR_PROJECT_NAME = 'Projet Ilef DevOps'  // CHANGE ICI : Ton nom de projet
        SONAR_HOST_URL = 'http://localhost:9000'
        // Le token est g√©r√© via Jenkins Credentials
    }

    stages {
        // Stage 1: R√©cup√©ration du code
        stage('üì• Checkout Git') {
            steps {
                echo 'üîÑ R√©cup√©ration du code depuis GitHub...'
                checkout scm
                // Affiche les infos du repo
                sh '''
                    echo "=== INFOS GIT ==="
                    echo "Repository: ${GIT_URL}"
                    echo "Branch: ${GIT_BRANCH}"
                    echo "Commit: $(git log -1 --pretty=format:"%H")"
                    echo "================"
                '''
            }
        }

        // Stage 2: Nettoyage
        stage('üßπ Maven Clean') {
            steps {
                echo 'Nettoyage du projet...'
                sh 'mvn clean'
            }
        }

        // Stage 3: Compilation
        stage('üî® Maven Compile') {
            steps {
                echo 'Compilation du code source...'
                sh 'mvn compile -DskipTests'
            }
        }

        // Stage 4: Tests Unitaires
        stage('üß™ Tests Unitaires') {
            steps {
                echo 'Ex√©cution des tests unitaires...'
                sh 'mvn test'
            }
            post {
                always {
                    // Archive les rapports de tests
                    junit '**/target/surefire-reports/*.xml'
                    echo 'Rapports de tests archiv√©s'
                }
            }
        }

        // Stage 5: Analyse SonarQube
        stage('üìä Analyse SonarQube') {
            steps {
                echo 'Analyse de la qualit√© du code avec SonarQube...'
                script {
                    // V√©rifie que SonarQube est accessible
                    sh '''
                        echo "=== V√âRIFICATION SONARQUBE ==="
                        echo "URL: ${SONAR_HOST_URL}"
                        echo "Project Key: ${SONAR_PROJECT_KEY}"
                        echo "Project Name: ${SONAR_PROJECT_NAME}"
                        echo "============================="
                    '''
                    
                    // Ex√©cute l'analyse SonarQube
                    withSonarQubeEnv('SonarQube') {
                        sh """
                        mvn sonar:sonar \
                          -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                          -Dsonar.projectName="${SONAR_PROJECT_NAME}" \
                          -Dsonar.sources=src/main/java \
                          -Dsonar.tests=src/test/java \
                          -Dsonar.java.binaries=target/classes \
                          -Dsonar.junit.reportsPath=target/surefire-reports \
                          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
                        """
                    }
                }
            }
        }

        // Stage 6: V√©rification Quality Gate
        stage('‚úÖ Quality Gate Check') {
            steps {
                echo 'V√©rification du Quality Gate...'
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: false
                }
                echo '‚úÖ Quality Gate valid√©!'
            }
        }

        // Stage 7: Packaging
        stage('üì¶ Build Package') {
            steps {
                echo 'Cr√©ation du package JAR...'
                sh 'mvn package -DskipTests'
            }
            post {
                success {
                    echo '‚úÖ Package cr√©√© avec succ√®s!'
                }
            }
        }

        // Stage 8: Documentation et Infos
        stage('üìÑ Documentation Build') {
            steps {
                echo 'G√©n√©ration de la documentation...'
                script {
                    // Cr√©e un fichier avec toutes les infos du build
                    def buildInfo = """
                    ===================================
                    üìã BUILD INFORMATION - ${SONAR_PROJECT_NAME}
                    ===================================
                    Date: ${new Date()}
                    Build Number: ${env.BUILD_NUMBER}
                    Job: ${env.JOB_NAME}
                    
                    === GIT INFORMATION ===
                    Repository: ${env.GIT_URL ?: 'Non disponible'}
                    Branch: ${env.GIT_BRANCH ?: 'Non disponible'}
                    Commit: ${sh(script: 'git log -1 --pretty=format:"%H" 2>/dev/null || echo "Non disponible"', returnStdout: true).trim()}
                    Author: ${sh(script: 'git log -1 --pretty=format:"%an" 2>/dev/null || echo "Non disponible"', returnStdout: true).trim()}
                    Message: ${sh(script: 'git log -1 --pretty=format:"%s" 2>/dev/null || echo "Non disponible"', returnStdout: true).trim()}
                    
                    === SONARQUBE ===
                    Project Key: ${SONAR_PROJECT_KEY}
                    Project Name: ${SONAR_PROJECT_NAME}
                    Dashboard: ${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}
                    
                    === JENKINS ===
                    Build URL: ${env.BUILD_URL}
                    ===================================
                    """
                    
                    writeFile file: 'build-info.md', text: buildInfo
                    
                    // Affiche un r√©sum√© dans les logs
                    echo """
                    üéâ BUILD R√âUSSI !
                    =================
                    Projet: ${SONAR_PROJECT_NAME}
                    Build: #${env.BUILD_NUMBER}
                    SonarQube: ${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}
                    """
                }
            }
        }
    }

    post {
        always {
            echo 'üì¶ Archivage des artefacts...'
            archiveArtifacts artifacts: 'target/*.jar, build-info.md', fingerprint: true
            
            // Nettoie pour le prochain build
            sh 'rm -f build-info.md || true'
            
            echo 'üßπ Nettoyage termin√©'
        }
        
        success {
            echo '‚úÖ‚úÖ‚úÖ PIPELINE R√âUSSIE ! ‚úÖ‚úÖ‚úÖ'
            script {
                // Lien vers SonarQube
                def sonarUrl = "${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}"
                echo "üìä Voir le rapport SonarQube: ${sonarUrl}"
                
                // Option: Envoyer un email
                // mail to: 'ilef.bt1@gmail.com',
                //     subject: "‚úÖ SUCC√àS - ${SONAR_PROJECT_NAME} - Build #${env.BUILD_NUMBER}",
                //     body: "La pipeline a r√©ussi!\n\nVoir SonarQube: ${sonarUrl}\nVoir Jenkins: ${env.BUILD_URL}"
            }
        }
        
        failure {
            echo '‚ùå‚ùå‚ùå PIPELINE √âCHOU√âE ! ‚ùå‚ùå‚ùå'
            script {
                // Option: Envoyer un email d'erreur
                // mail to: 'ilef.bt1@gmail.com',
                //     subject: "‚ùå √âCHEC - ${SONAR_PROJECT_NAME} - Build #${env.BUILD_NUMBER}",
                //     body: "La pipeline a √©chou√©!\n\nVoir les logs: ${env.BUILD_URL}/console"
            }
        }
        
        changed {
            echo 'üîÑ Statut du build modifi√© depuis la derni√®re ex√©cution'
        }
    }
}